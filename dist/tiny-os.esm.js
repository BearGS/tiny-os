var MAX_APP=5,AppState={UNREGISTER:"unregister",UNLOAD:"unload",BACKEND:"backend",FRONTEND:"frontend"},OsHandler={REGISTER:"register",LOAD:"load",OPEN:"open",SUSPEND:"suspend",KILL:"kill"},AppPriority={FORERVER:"forever",TEMPORARY:"temporary"},validateFormat=function(){};function invariant(t,e){for(var n=arguments.length,r=Array(n>2?n-2:0),a=2;a<n;a++)r[a-2]=arguments[a];if(validateFormat(e),t){var i=void 0;if(void 0===e)i=new Error("Minified exception occurred use the non-minified dev environment for the full error message and additional helpful warnings.");else{var o=0;i=new Error(e.replace(/%s/g,function(){return r[o++]}))}throw i.framesToPop=1,i}}var createRouterManager=function(){var t=[];return{notify:function(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];return t.forEach(function(t){return t.apply(void 0,n)})},add:function(e){return t.push(e),function(){t=t.filter(function(t){return t!==e})}}}};function createHistoryFactory(t){var e=createRouterManager(),n=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.path,a=void 0===n?r.location.pathname:n,i=t.state,o=void 0===i?r.state:i,u=t.hash,s=void 0===u?r.location.hash:u,p=t.handler,l=void 0===p?"":p;e.notify({path:a,state:o,hash:s,handler:l})};window.addEventListener("popstate",function(){}),window.addEventListener("hashchange",function(){n()});var r={go:function(e){return t.go(e)},back:function(){return t.go(-1)},forward:function(){return t.go(1)},push:function(e,r,a){t.pushState(r,"",e),n({handler:a})},replace:function(e,r,a){t.replaceState(r,"",e),n({handler:a})},setHash:function(e){var a=e.hash,i=e.handler;r.location.hash!=="#"+a&&(t.pushState(null,null,"#"+a),n({handler:i}))},listen:function(t){return e.add(t)},state:t.state,length:t.length,location:window.location};return r}function createIframe(t,e,n){var r=document.createElement("iframe");return r.setAttribute("id",e),r.setAttribute("src",n),r.setAttribute("sandbox","allow-forms allow-same-origin allow-scripts allow-popups"),r.style.border="none",r.style.display="none",t.appendChild(r),r}function hideIframe(t){t.style.display="none"}function showIframe(t){t.style.display=null}function removeIframe(t,e){var n=document.getElementById(e);t.removeChild(n)}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},currentUrl="",routerMap=[],iframeMap=[];function getIframe(t){var e=iframeMap.find(function(e){return e.name===t.name});return invariant(!e,"No such Iframe named `"+t.name+"`"),e.iframe}function getRouter(t){var e=routerMap.find(function(e){return e.name===t});return invariant(!e,"No such router named `"+t+"`"),e}var Router=function t(e){var n=this;classCallCheck(this,t),this.container=window.document.body,this.updateRouterMap=function(t){routerMap=t},this.configContainer=function(t){n.container="string"==typeof t?document.getElementById(t):t},this.goRouter=function(t){var e=t.name,r=t.handler;return n.history.setHash({hash:e,handler:r})},this.render=function(t){var e=t.name,r=void 0===e?"":e,a=t.handler,i=getRouter(r);switch(a){case OsHandler.LOAD:n.loadIframe(i);break;case OsHandler.OPEN:showIframe(getIframe(i));break;case OsHandler.SUSPEND:hideIframe(getIframe(i));break;case OsHandler.KILL:n.killIframe(i)}},this.loadIframe=function(t){var e=t.name,r=t.url;if(!iframeMap.find(function(t){return t.name===e})){var a=createIframe(n.container,e,r);iframeMap.push({name:e,iframe:a})}},this.killIframe=function(t){var e=t.name;removeIframe(n.container,e),iframeMap=iframeMap.filter(function(t){return t.name!==e})},this.getCurrentUrl=function(){return currentUrl},this.getRouterMap=function(){return routerMap},currentUrl=e||window.location.hash||"",this.history=createHistoryFactory(window.history)},router=new Router;function sortAppByLRU(t,e){return t.priority===AppPriority.FORERVER?-1:e.priority===AppPriority.FORERVER?1:t.loadTime>e.loadTime?-1:1}var _apps=[];function setBackend(t){t.state=AppState.BACKEND,t.loadTime=Date.now()}function setFrontend(t){t.state=AppState.FRONTEND}function setUnload(t){t.state=AppState.UNLOAD,t.loadTime=0}function updateRouter(t){router.updateRouterMap(_apps),t&&(router.render(t),t.handler===OsHandler.OPEN&&router.goRouter(t))}var AppManager=function t(){var e=this;if(classCallCheck(this,t),this.register=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.name,r=t.url,a=t.priority,i=void 0===a?AppPriority.TEMPORARY:a;invariant(!n||"string"!=typeof n,"Invalid params name"),invariant(!r||"string"!=typeof r,"Invalid params url"),invariant(e.getApp(n,!0),"you've already register another app named `"+n+"`");var o={name:n,url:r,priority:i};_apps.unshift(o),setUnload(o),updateRouter()},this.registerAll=function(t){t.forEach(function(t){return e.register(t)})},this.onOuterAppChange=function(t){var n=t.hash,r=void 0===n?"":n;if(r){var a=r.slice(1),i=e.getApp(a,!0);i?e.launch(i.name):window.location.hash=r}},this.launch=function(t){var n=e.getApp(t);e.suspendOpendApp().load(n).open(n).killOverflowApp()},this.load=function(t){return setBackend(t),_apps.sort(sortAppByLRU),updateRouter(_extends({},t,{handler:OsHandler.LOAD})),e},this.open=function(t){return setFrontend(t),updateRouter(_extends({},t,{handler:OsHandler.OPEN})),e},this.suspend=function(t){return setBackend(t),updateRouter(_extends({},t,{handler:OsHandler.SUSPEND})),e},this.kill=function(t){return setUnload(t),updateRouter(_extends({},t,{handler:OsHandler.KILL})),e},this.suspendOpendApp=function(){return _apps.filter(function(t){return t.state===AppState.FRONTEND}).forEach(function(t){return e.suspend(t)}),e},this.killOverflowApp=function(){var t=_apps.filter(function(t){return t.state===AppState.BACKEND});if(t.length>=MAX_APP){var n=t.pop();e.kill(n)}return e},this.getApps=function(){return _apps},this.getApp=function(t,e){var n=_apps.find(function(e){return e.name===t});return invariant(!e&&!n,"No such App named `"+t+"`"),n},this.getUnloadApps=function(){return _apps.filter(function(t){return t.state===AppState.UNLOAD})},this.getBackendApps=function(){return _apps.filter(function(t){return t.state===AppState.BACKEND})},this.getFrontendApps=function(){return _apps.filter(function(t){return t.state===AppState.FRONTEND})},"object"===_typeof(t.instance)&&t.instance instanceof t)return t.instance;Object.defineProperty(t,"instance",{value:this,configurable:!1,writable:!1}),router.history.listen(this.onOuterAppChange.bind(this))},appManager=new AppManager,_modules={},Host=function t(){var e=this;if(classCallCheck(this,t),this.launchApp=function(t){return appManager.launch(t)},this.registerApp=function(t){return appManager.register(t)},this.registerAll=function(t){return appManager.registerAll(t)},this.configContainer=function(t){return router.configContainer(t)},this.getApps=function(){return appManager.getApps()},this.use=function(t){for(var n=arguments.length,r=Array(n>1?n-1:0),a=1;a<n;a++)r[a-1]=arguments[a];if(!t.installed)return t.install(e.modules,r),t.installed=!0,e},this.getModules=function(){return _modules},this.getModule=function(t){return _modules[t]},"object"===_typeof(t.instance)&&t.instance instanceof t)return t.instance;Object.defineProperty(t,"instance",{value:this,configurable:!1,writable:!1})};export{Host};
